<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Moon Phases Since Birth</title>
<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: sans-serif;
    background: #000;
    overflow: hidden;
  }
  /* -------------------------
     INPUT SCREEN
     ------------------------- */
  #input-screen {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(to bottom, #333, #111);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: #fff;
  }
  #birthdate-input {
    padding: 10px;
    font-size: 18px;
    width: 250px;
    margin-bottom: 10px;
  }
  #start-button {
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    background: #555;
    color: #fff;
    border: none;
    border-radius: 5px;
  }

  /* -------------------------
     CANVAS
     ------------------------- */
  #star-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: none; /* hidden at first */
    background: #000;
  }

  /* -------------------------
     INFO PANEL
     ------------------------- */
  #info-panel {
    position: absolute;
    top: 20px; left: 20px;
    color: #fff;
    font-size: 18px;
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 8px;
    display: none; /* shown after start */
  }
  #info-panel h2 {
    margin: 0 0 5px 0;
    font-size: 22px;
  }

  /* -------------------------
     NEXT MILESTONE BUTTON
     ------------------------- */
  #next-milestone-btn {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    padding: 15px 30px;
    font-size: 20px;
    cursor: pointer;
    background: #666;
    color: #fff;
    border: none;
    border-radius: 8px;
    display: none; /* shown when present-day is reached */
  }

  /* Highlight for final or milestone count */
  .highlight {
    font-size: 28px;
    color: #ffd700;
    font-weight: bold;
    animation: pulse 1.5s infinite alternate;
  }
  @keyframes pulse {
    from { transform: scale(1);   }
    to   { transform: scale(1.2); }
  }
</style>
</head>
<body>

<!-- 1. INPUT SCREEN -->
<div id="input-screen">
  <h1>Enter Your Birth Date</h1>
  <input type="date" id="birthdate-input" />
  <button id="start-button">Start</button>
</div>

<!-- 2. ANIMATED SCENE (Canvas) -->
<canvas id="star-canvas"></canvas>

<!-- 3. INFO PANEL -->
<div id="info-panel">
  <h2 id="moon-count">0 FULL MOONS LIVED</h2>
  <div id="moon-date">Date: N/A</div>
</div>

<!-- 4. NEXT MILESTONE BUTTON -->
<button id="next-milestone-btn"></button>

<script>
/* ---------------------------------------------------------
   GLOBALS & DOM ELEMENTS
   --------------------------------------------------------- */
const inputScreen    = document.getElementById('input-screen');
const birthInput     = document.getElementById('birthdate-input');
const startButton    = document.getElementById('start-button');
const starCanvas     = document.getElementById('star-canvas');
const ctx            = starCanvas.getContext('2d');

const infoPanel      = document.getElementById('info-panel');
const moonCountEl    = document.getElementById('moon-count');
const moonDateEl     = document.getElementById('moon-date');
const milestoneBtn   = document.getElementById('next-milestone-btn');

/* We'll assume an average lunar cycle length in days. */
const LUNAR_CYCLE_DAYS = 29.53059;

/* Starfield info */
let stars = [];
const NUM_STARS = 100;

/* Animation timeline variables */
let userBirthdate          = null;  // string from input
let totalFullMoons         = 0;     // up to present day
let nextMilestone          = 0;     // 10 or nearest 100
let startCycle             = 0;     // start of animation range
let currentEndCycle        = 0;     // target cycle index (end of animation range)
let animationComplete      = false; // have we reached currentEndCycle?
let startTime              = 0;     // when the current animation began
let totalAnimationDuration = 10000; // default 10s from 0..present
let freezeAnimation        = false; // used to stop drawing moon if needed

/* ---------------------------------------------------------
   ON PAGE LOAD: ADJUST CANVAS SIZE
   --------------------------------------------------------- */
function resizeCanvas() {
  starCanvas.width  = window.innerWidth;
  starCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

/* ---------------------------------------------------------
   CALCULATE FULL MOONS & DATES
   --------------------------------------------------------- */
function calculateFullMoons(birthdate) {
  const birthTime = new Date(birthdate).getTime();
  const nowTime   = Date.now();
  const diffDays  = (nowTime - birthTime) / (1000*60*60*24);
  if (diffDays < 0) return 0; // future birthdate fallback
  return Math.floor(diffDays / LUNAR_CYCLE_DAYS);
}

function cycleIndexToDate(birthdate, index) {
  const birth = new Date(birthdate);
  const daysAfter = index * LUNAR_CYCLE_DAYS;
  return new Date(birth.getTime() + daysAfter * 86400000);
}

/* Determine next milestone (10 if <10, else next multiple of 100) */
function computeNextMilestone(currentCount) {
  if (currentCount < 10) return 10;
  return Math.ceil(currentCount / 100) * 100;
}

/* ---------------------------------------------------------
   START BUTTON HANDLER
   --------------------------------------------------------- */
startButton.addEventListener('click', () => {
  if (!birthInput.value) return;
  userBirthdate  = birthInput.value;
  totalFullMoons = calculateFullMoons(userBirthdate);

  // Hide the input screen, show the canvas + info panel
  inputScreen.style.display = 'none';
  starCanvas.style.display  = 'block';
  infoPanel.style.display   = 'block';

  // Initialize starfield
  initStars();
  resizeCanvas();

  // Setup initial animation: from cycle 0 -> totalFullMoons
  startCycle      = 0;
  currentEndCycle = totalFullMoons;
  animationComplete = false;
  freezeAnimation   = false;
  startTime         = performance.now();
  nextMilestone     = computeNextMilestone(totalFullMoons);
  milestoneBtn.style.display = 'none'; // hidden until we finish the present-day run

  requestAnimationFrame(animationLoop);
});

/* ---------------------------------------------------------
   STARFIELD
   --------------------------------------------------------- */
function initStars() {
  stars = [];
  for (let i = 0; i < NUM_STARS; i++) {
    stars.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      vx: (Math.random() - 0.5) * 0.02,
      vy: (Math.random() - 0.5) * 0.02,
      size: Math.random() * 1.5 + 0.5
    });
  }
}

/* ---------------------------------------------------------
   MAIN ANIMATION LOOP
   --------------------------------------------------------- */
function animationLoop(timestamp) {
  // Clear canvas
  ctx.clearRect(0, 0, starCanvas.width, starCanvas.height);

  // 1) Update & draw stars
  updateAndDrawStars();

  // 2) If not freezing, compute cycle index for this moment
  let cycleIndexFloat = startCycle;
  if (!freezeAnimation) {
    cycleIndexFloat = getCurrentCycleIndex(timestamp);
  }

  // 3) Draw moon according to fractional cycle
  const intPart  = Math.floor(cycleIndexFloat);
  const fracPart = cycleIndexFloat - intPart;

  drawMoon(fracPart);

  // 4) Update text
  moonCountEl.textContent = `${intPart} FULL MOONS LIVED`;
  const cycleDate = cycleIndexToDate(userBirthdate, intPart);
  moonDateEl.textContent = `Date: ${cycleDate.toDateString()}`;

  // 5) Check if we have completed the target cycle
  if (animationComplete && !freezeAnimation) {
    // Freeze the moon so it doesn't jiggle
    freezeAnimation = true;

    // Highlight the count
    moonCountEl.classList.add('highlight');
    // Show the next milestone button in the center
    milestoneBtn.textContent = `Next Milestone: ${nextMilestone} Moons`;
    milestoneBtn.style.display = 'block';
  }

  requestAnimationFrame(animationLoop);
}

/* ---------------------------------------------------------
   ANIMATION HELPER
   --------------------------------------------------------- */

/**
 * Maps real time to a fractional position from startCycle..currentEndCycle.
 * We use an "ease-out" approach for a smooth finish.
 */
function getCurrentCycleIndex(currentTime) {
  if (animationComplete) return currentEndCycle;

  let elapsed  = currentTime - startTime;
  let fraction = Math.min(1, elapsed / totalAnimationDuration);

  // Ease out: simple quadratic
  fraction = easeOutQuad(fraction);

  let val = startCycle + fraction * (currentEndCycle - startCycle);
  if (fraction >= 1) {
    val = currentEndCycle;
    animationComplete = true;
  }
  return val;
}

/** A simple ease-out function: f(t) = 1 - (1 - t)^2 */
function easeOutQuad(t) {
  return 1 - (1 - t) * (1 - t);
}

/* ---------------------------------------------------------
   DRAW MOON (REALISTIC CRESCENT)
   --------------------------------------------------------- */
function drawMoon(phase) {
  // Convert 0..1 to litFraction in 0..1..0
  let litFraction = (phase <= 0.5)
    ? phase / 0.5              // waxing
    : 1 - (phase - 0.5)/0.5;   // waning

  const cx = starCanvas.width / 2;
  const cy = starCanvas.height / 2;
  const radius = Math.min(starCanvas.width, starCanvas.height) * 0.35;

  // Draw base moon
  ctx.save();
  ctx.translate(cx, cy);
  ctx.fillStyle = '#ccc';
  ctx.beginPath();
  ctx.arc(0, 0, radius, 0, 2*Math.PI, false);
  ctx.fill();

  // Shadow offset approach
  ctx.globalCompositeOperation = 'destination-out';
  const alpha  = 2 * litFraction - 1;    // range -1..1
  const offset = alpha * 2 * radius;

  ctx.beginPath();
  ctx.arc(offset, 0, radius, 0, 2*Math.PI, false);
  ctx.fill();

  ctx.restore();
  ctx.globalCompositeOperation = 'source-over';
}

/* Update star positions & draw them */
function updateAndDrawStars() {
  for (let i = 0; i < stars.length; i++) {
    const s = stars[i];
    s.x += s.vx;
    s.y += s.vy;
    if (s.x < 0) s.x = starCanvas.width;
    if (s.x > starCanvas.width) s.x = 0;
    if (s.y < 0) s.y = starCanvas.height;
    if (s.y > starCanvas.height) s.y = 0;

    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size, 0, 2*Math.PI);
    ctx.fill();
  }
}

/* ---------------------------------------------------------
   NEXT MILESTONE BUTTON (FAST FORWARD)
   --------------------------------------------------------- */
milestoneBtn.addEventListener('click', () => {
  // If we're already at or past the milestone, do nothing
  if (currentEndCycle >= nextMilestone) return;

  // Un-freeze, un-highlight
  freezeAnimation     = false;
  animationComplete   = false;
  moonCountEl.classList.remove('highlight');
  milestoneBtn.style.display = 'none';

  // Start from currentEndCycle, go to nextMilestone
  startCycle      = currentEndCycle;
  currentEndCycle = nextMilestone;
  startTime       = performance.now();
  totalAnimationDuration = 5000; // fast-forward in 5s, can be adjusted
});
</script>
</body>
</html>
