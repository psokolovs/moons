<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hyper-Realistic Moon Journey</title>
  <style>
    /* Reset and full-screen basics */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    /* Input Screen */
    #inputScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      text-align: center;
    }
    #inputScreen h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
    }
    #birthForm {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }
    #birthForm input[type="date"] {
      width: 320px; /* wide enough for a 4-digit year */
      max-width: 90%;
      font-size: 1.2em;
      padding: 10px;
      border: 2px solid #fff;
      background: #111;
      color: #fff;
    }
    #birthForm button {
      font-size: 1.2em;
      padding: 10px 20px;
      background: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    #birthForm button:hover {
      background: #ccc;
    }
    /* Canvas takes up the full screen */
    #sceneCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 5;
    }
    /* Overlay for controls and info */
    #overlay {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      z-index: 20;
    }
    #counterOverlay {
      font-size: 2em;
      margin-bottom: 10px;
      opacity: 0;
      transition: opacity 1s;
    }
    #milestoneOverlay {
      font-size: 1.5em;
      margin-bottom: 10px;
      opacity: 0;
      transition: opacity 1s;
    }
    /* Play (Fast Forward) and Share buttons */
    #playButton, #shareButton {
      font-size: 1.2em;
      padding: 10px 20px;
      background: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      display: none;
      margin: 5px;
    }
    #playButton:hover, #shareButton:hover {
      background: #ccc;
    }
  </style>
</head>
<body>
  <!-- Input Screen -->
  <div id="inputScreen">
    <h1>Moon Life Journey</h1>
    <form id="birthForm">
      <input type="date" id="birthdate" required />
      <button type="submit">Calculate My Moons</button>
    </form>
  </div>

  <!-- Full-screen Canvas -->
  <canvas id="sceneCanvas"></canvas>

  <!-- Overlay for counter, buttons, and milestone info -->
  <div id="overlay">
    <div id="counterOverlay"></div>
    <button id="playButton">Fast Forward</button>
    <div id="milestoneOverlay"></div>
    <button id="shareButton">Share Your Journey</button>
  </div>

  <script>
    /************* GLOBAL VARIABLES & SETUP *************/
    const lunarMonth = 29.53059; // days per lunar cycle
    let fullMoonsLived = 0;
    let milestone = 0;
    let currentRevolution = 0; // how many revolutions have been completed (including slow spin)
    let phase = "slow"; // phases: "slow", "waiting", "fast", "done"
    let currentRotationAngle = 0; // in radians

    // Get elements
    const inputScreen = document.getElementById('inputScreen');
    const birthForm = document.getElementById('birthForm');
    const birthdateInput = document.getElementById('birthdate');
    const sceneCanvas = document.getElementById('sceneCanvas');
    const ctx = sceneCanvas.getContext('2d');
    const counterOverlay = document.getElementById('counterOverlay');
    const playButton = document.getElementById('playButton');
    const milestoneOverlay = document.getElementById('milestoneOverlay');
    const shareButton = document.getElementById('shareButton');

    // Set max date for input to today
    birthdateInput.max = new Date().toISOString().split("T")[0];

    // Set up canvas dimensions and update moon parameters on resize
    function resizeCanvas() {
      sceneCanvas.width = window.innerWidth;
      sceneCanvas.height = window.innerHeight;
      // Update moon object to be centered and large
      moon.x = sceneCanvas.width / 2;
      moon.y = sceneCanvas.height / 2;
      moon.radius = Math.min(sceneCanvas.width, sceneCanvas.height) * 0.45;
    }
    window.addEventListener('resize', resizeCanvas);

    /************* MOON OBJECT & DRAWING *************/
    // The moon will be drawn at the center
    const moon = {
      x: 0,
      y: 0,
      radius: 0 // will be set on resize
    };

    // Draw the moon with a realistic radial gradient and subtle craters
    function drawMoon(angle) {
      ctx.save();
      // Translate to moon center
      ctx.translate(moon.x, moon.y);
      // Rotate by the given angle
      ctx.rotate(angle);
      // Create a radial gradient for a realistic look
      const grad = ctx.createRadialGradient(
        -moon.radius * 0.3, -moon.radius * 0.3, moon.radius * 0.1,
        0, 0, moon.radius
      );
      grad.addColorStop(0, '#e0e0e0');
      grad.addColorStop(1, '#777777');
      ctx.beginPath();
      ctx.arc(0, 0, moon.radius, 0, 2 * Math.PI);
      ctx.fillStyle = grad;
      ctx.fill();
      // Simulate subtle craters (random positions each frame for a natural feel)
      ctx.fillStyle = 'rgba(0,0,0,0.15)';
      for (let i = 0; i < 8; i++) {
        const cx = (Math.random() - 0.5) * moon.radius * 0.8;
        const cy = (Math.random() - 0.5) * moon.radius * 0.8;
        const cr = Math.random() * moon.radius * 0.07;
        ctx.beginPath();
        ctx.arc(cx, cy, cr, 0, 2 * Math.PI);
        ctx.fill();
      }
      ctx.restore();
    }

    /************* ANIMATION LOOP *************/
    let slowStartTime = null;
    function drawScene(timestamp) {
      ctx.clearRect(0, 0, sceneCanvas.width, sceneCanvas.height);

      // For our hyperâ€‘realistic background, draw a subtle starfield
      drawStarfield();

      // Draw only the moon (centered) with the current rotation angle
      drawMoon(currentRotationAngle);

      // Phase-dependent updates
      if (phase === "slow") {
        if (!slowStartTime) slowStartTime = timestamp;
        let elapsed = timestamp - slowStartTime;
        if (elapsed < 10000) { // 10 seconds for one revolution
          currentRotationAngle = (elapsed / 10000) * 2 * Math.PI;
        } else {
          // End of slow spin; complete one revolution
          currentRotationAngle = 0;
          currentRevolution = 1;
          phase = "waiting";
          // Show the play (fast-forward) button
          playButton.style.display = "inline-block";
          counterOverlay.style.opacity = 1;
          counterOverlay.innerText = currentRevolution + " FULL MOON" + (currentRevolution === 1 ? "" : "S") + " LIVED";
        }
      }
      // In "waiting" phase, do nothing; the moon remains static.
      // In "fast" phase, the rotation is controlled by the fast-forward routine.
      // In "done" phase, nothing changes.

      requestAnimationFrame(drawScene);
    }

    // A simple starfield drawn with many small white dots
    const stars = [];
    const numStars = 300;
    function initStars() {
      stars.length = 0;
      for (let i = 0; i < numStars; i++) {
        stars.push({
          x: Math.random() * sceneCanvas.width,
          y: Math.random() * sceneCanvas.height,
          radius: Math.random() * 1.5,
          alpha: Math.random() * 0.8 + 0.2
        });
      }
    }
    function drawStarfield() {
      for (let star of stars) {
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
        ctx.fillStyle = `rgba(255,255,255,${star.alpha})`;
        ctx.fill();
      }
    }

    /************* FAST-FORWARD SPIN (Phase 3) *************/
    // This function animates one fast-forward revolution.
    function animateRevolution(duration) {
      return new Promise((resolve) => {
        let startTime = null;
        function step(timestamp) {
          if (!startTime) startTime = timestamp;
          let progress = timestamp - startTime;
          let angle = (progress / duration) * 2 * Math.PI;
          currentRotationAngle = angle;
          if (progress < duration) {
            requestAnimationFrame(step);
          } else {
            // Complete the revolution
            currentRotationAngle = 0;
            resolve();
          }
        }
        requestAnimationFrame(step);
      });
    }

    // This async function runs the fast-forward sequence.
    async function runFastForward() {
      playButton.style.display = "none"; // hide the play button while animating
      let remainingRevolutions = fullMoonsLived - currentRevolution;
      for (let i = 0; i < remainingRevolutions; i++) {
        // For the first fast-forward revolution, use 1 second; then use 0.1 sec for subsequent ones.
        let duration = (i === 0) ? 1000 : 100;
        await animateRevolution(duration);
        currentRevolution++;
        counterOverlay.innerText = currentRevolution + " FULL MOON" + (currentRevolution === 1 ? "" : "S") + " LIVED";
      }
      // When fast-forward is complete, move to the "done" phase.
      phase = "done";
      showMilestoneOverlay();
    }

    /************* MILESTONE & SHARE *************/
    function showMilestoneOverlay() {
      // Determine the next milestone: if fewer than 10, milestone = 10; otherwise, next multiple of 100.
      milestone = (fullMoonsLived < 10) ? 10 : Math.ceil(fullMoonsLived / 100) * 100;
      let moonsRemaining = milestone - fullMoonsLived;
      milestoneOverlay.innerHTML = `Your next milestone is <strong>${milestone}</strong> full moons.<br>
                                    You have <strong>${moonsRemaining}</strong> more to go.`;
      // Fade in the milestone overlay
      milestoneOverlay.style.opacity = 1;
      // Show the share button
      shareButton.style.display = "inline-block";
    }

    // Share button functionality
    shareButton.addEventListener('click', function() {
      const shareData = {
        title: "My Moon Life Journey",
        text: "I've lived " + fullMoonsLived + " full moons so far!",
        url: window.location.href
      };
      if (navigator.share) {
        navigator.share(shareData).catch(err => console.error("Error sharing:", err));
      } else {
        copyToClipboard(window.location.href);
        alert("Link copied to clipboard!");
      }
    });
    function copyToClipboard(text) {
      const tempInput = document.createElement("input");
      tempInput.style.position = "absolute";
      tempInput.style.left = "-1000px";
      tempInput.value = text;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand("copy");
      document.body.removeChild(tempInput);
    }

    /************* FORM HANDLING & INIT *************/
    birthForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const birthDateStr = birthdateInput.value;
      if (!birthDateStr) return;
      const birthDate = new Date(birthDateStr);
      const currentDate = new Date();
      const daysLived = (currentDate - birthDate) / (1000 * 60 * 60 * 24);
      fullMoonsLived = Math.floor(daysLived / lunarMonth);
      if (fullMoonsLived < 1) fullMoonsLived = 1; // Ensure at least one revolution
      
      // Hide the input screen and initialize canvas
      inputScreen.style.display = "none";
      sceneCanvas.style.display = "block";
      initStars();
      resizeCanvas();
      requestAnimationFrame(drawScene);
    });

    // When the play button is clicked, begin the fast-forward phase.
    playButton.addEventListener('click', function() {
      if (phase === "waiting") {
        phase = "fast";
        runFastForward();
      }
    });

    // Start the animation loop (the slow phase will run until 10 sec have elapsed)
    requestAnimationFrame(drawScene);
  </script>
</body>
</html>
